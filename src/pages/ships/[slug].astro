---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import PricingTable from "../../components/PricingTable.astro";
import ItinerarySection from "../../components/ItinerarySection.astro";
import { getShips, getShip, formatStatus } from "../../lib/strapi";

export async function getStaticPaths() {
  const ships = await getShips();
  return ships.map((ship) => ({
    params: { slug: ship.slug },
  }));
}

const { slug } = Astro.params;
const ship = await getShip(slug!);

if (!ship) {
  return Astro.redirect("/404");
}

const apartments = ship.apartments || [];
const itinerary = ship.itineraries?.[0];
const operator = ship.operator;
const stories = ship.stories || [];

const statusColors: Record<string, string> = {
  operational: "bg-green-500/20 text-green-300 border-green-500/30",
  "under-construction": "bg-amber-500/20 text-amber-300 border-amber-500/30",
  planned: "bg-blue-500/20 text-blue-300 border-blue-500/30",
};
---

<Layout title={ship.name} description={ship.tagline}>
  <Header />
  <main>
    <!-- Hero -->
    <section class="relative py-20 sm:py-28 overflow-hidden">
      <div class="absolute inset-0 bg-gradient-to-b from-ocean-dark via-navy to-navy-light"></div>
      <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <a href="/" class="inline-flex items-center gap-2 text-white/60 hover:text-gold mb-8 transition-colors text-sm">
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path d="M15 19l-7-7 7-7" />
          </svg>
          Back to Ships
        </a>
        <div class="max-w-3xl">
          <span class={`inline-block px-3 py-1 text-xs font-medium rounded-full border mb-4 ${statusColors[ship.status]}`}>
            {formatStatus(ship.status)}
          </span>
          <h1 class="font-heading text-4xl sm:text-6xl font-bold text-white mb-4">
            {ship.name}
          </h1>
          <p class="text-xl text-gold mb-8">{ship.tagline}</p>
          <div class="flex flex-wrap gap-6">
            <div class="flex items-center gap-2">
              <svg class="w-5 h-5 text-gold" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
              </svg>
              <span class="text-white"><strong class="text-gold">{ship.length}m</strong> Length</span>
            </div>
            <div class="flex items-center gap-2">
              <svg class="w-5 h-5 text-gold" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
              </svg>
              <span class="text-white"><strong class="text-gold">{ship.residenceCount}</strong> Residences</span>
            </div>
            <div class="flex items-center gap-2">
              <svg class="w-5 h-5 text-gold" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <span class="text-white"><strong class="text-gold">{ship.yearBuilt}</strong> Year</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Description -->
    <section class="py-16 bg-theme-primary">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="max-w-3xl">
          <h2 class="font-heading text-2xl font-bold text-theme-primary mb-6">About {ship.name}</h2>
          <div class="prose prose-lg text-theme-secondary leading-relaxed whitespace-pre-line">
            {ship.description}
          </div>
        </div>
      </div>
    </section>

    <!-- Operator Info -->
    {operator && (
      <section class="py-16 bg-theme-secondary">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <h2 class="font-heading text-2xl font-bold text-theme-primary mb-8">Operator</h2>
          <div class="rounded-2xl bg-theme-card border border-theme p-8">
            <h3 class="font-heading text-xl font-bold text-accent-primary mb-4">{operator.name}</h3>
            <p class="text-theme-secondary mb-6 leading-relaxed">{operator.description}</p>
            <div class="flex flex-wrap gap-6 text-sm">
              {operator.website && (
                <a href={operator.website} target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-accent-secondary hover:text-accent-primary transition-colors">
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9" />
                  </svg>
                  {operator.website}
                </a>
              )}
              {operator.phone && (
                <a href={`tel:${operator.phone}`} class="flex items-center gap-2 text-accent-secondary hover:text-accent-primary transition-colors">
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                  </svg>
                  {operator.phone}
                </a>
              )}
              {operator.email && (
                <a href={`mailto:${operator.email}`} class="flex items-center gap-2 text-accent-secondary hover:text-accent-primary transition-colors">
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                  </svg>
                  {operator.email}
                </a>
              )}
            </div>
          </div>
        </div>
      </section>
    )}

    <!-- Apartments/Pricing -->
    {apartments.length > 0 && (
      <section class="py-16 bg-theme-primary">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <h2 class="font-heading text-2xl font-bold text-theme-primary mb-8">Residences & Pricing</h2>
          <div class="rounded-2xl bg-theme-card border border-theme overflow-hidden">
            <PricingTable apartments={apartments} />
          </div>
          {apartments.length > 0 && (
            <div class="mt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {apartments.map((apt) => (
                <div class="rounded-xl bg-theme-card border border-theme p-6 hover:border-gold/30 transition-colors">
                  <h3 class="font-heading font-bold text-theme-primary mb-2">{apt.name}</h3>
                  <p class="text-theme-secondary text-sm leading-relaxed">{apt.description}</p>
                </div>
              ))}
            </div>
          )}
        </div>
      </section>
    )}

    <!-- Itinerary -->
    {itinerary && itinerary.stops && itinerary.stops.length > 0 && (
      <section class="py-16 bg-theme-secondary">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <h2 class="font-heading text-2xl font-bold text-theme-primary mb-8">Itinerary</h2>
          <ItinerarySection itinerary={itinerary} shipName={ship.name} />
        </div>
      </section>
    )}

    <!-- Related Stories -->
    {stories.length > 0 && (
      <section class="py-16 bg-theme-primary">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <h2 class="font-heading text-2xl font-bold text-theme-primary mb-8">Related Stories</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            {stories.map((story) => (
              <a href={`/stories/${story.slug}`} class="group block rounded-2xl bg-theme-card border border-theme p-6 hover:border-gold/30 hover:-translate-y-1 transition-all">
                <h3 class="font-heading text-lg font-bold text-theme-primary group-hover:text-accent-primary transition-colors mb-2">
                  {story.title}
                </h3>
                <p class="text-theme-secondary text-sm line-clamp-3">{story.excerpt}</p>
                <p class="text-theme-muted text-xs mt-4">By {story.author}</p>
              </a>
            ))}
          </div>
        </div>
      </section>
    )}
  </main>
  <Footer />
</Layout>
